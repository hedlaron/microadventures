name: image-ci

on:
  push:
    branches:
      - "master"
    tags:
      - "[0-9]*.[0-9]*.[0-9]*"
    paths:
      # Only rebuild images when applications change
      - "components/**/*"
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Custom image tag (optional, will auto-generate if not provided)'
        required: false
        type: string
      component:
        description: 'Component to build'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'backend'
          - 'frontend'

jobs:
  generate-image-tag:
    # initial tag created manually --> git tag -a v0.0.1 -m "Initial tag"
    # --> git push origin --tags
    # subsequent tags created automatically by this workflow
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      image_tag: ${{ steps.generate-image-tag.outputs.image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Necessary to get all tags for IMAGE_TAG generation with git describe
          fetch-depth: 0

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: 3.x

      - name: Generate Image Tag
        id: generate-image-tag
        working-directory: cicd/github-actions
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.image_tag }}" ]]; then
            image_tag="${{ github.event.inputs.image_tag }}"
          else
            image_tag=$(task generate-version-tag)
          fi
          echo "image_tag=$image_tag" >> $GITHUB_OUTPUT

  determine-components:
    runs-on: ubuntu-latest
    outputs:
      components: ${{ steps.filter.outputs.components }}
    steps:
      - name: Determine components to build
        id: filter
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            component="${{ github.event.inputs.component }}"
            if [[ "$component" == "all" ]]; then
              echo 'components=["components/backend", "components/frontend"]' >> $GITHUB_OUTPUT
            elif [[ "$component" == "backend" ]]; then
              echo 'components=["components/backend"]' >> $GITHUB_OUTPUT
            elif [[ "$component" == "frontend" ]]; then
              echo 'components=["components/frontend"]' >> $GITHUB_OUTPUT
            fi
          else
            # For push events, build all components
            echo 'components=["components/backend", "components/frontend"]' >> $GITHUB_OUTPUT
          fi

  build-tag-push:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [generate-image-tag, determine-components]
    strategy:
      fail-fast: false
      matrix:
        path: ${{ fromJson(needs.determine-components.outputs.components) }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_microadventures
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: 3.x

      - name: Run tests in container
        working-directory: ${{ matrix.path }}
        env:
          IMAGE_TAG: ${{ needs.generate-image-tag.outputs.image_tag }}
          # Test environment variables
          JWT_SECRET_KEY: test-secret-key-for-ci
          POSTGRESQL_USERNAME: postgres
          POSTGRESQL_PASSWORD: postgres
          POSTGRESQL_SERVER: localhost
          POSTGRESQL_PORT: 5432
          POSTGRESQL_DATABASE: test_microadventures
          OPENAI_API_KEY: test-api-key-for-ci
        run: |
          echo "Running tests in Docker container for ${{ matrix.path }}"

          # Create a temporary file to capture test output
          TEST_OUTPUT_FILE="/tmp/test_output_${{ matrix.path }}.log"

          if [[ "${{ matrix.path }}" == "components/backend" ]]; then
            echo "Building and testing backend in container..."
            # Build test stage and run tests, capturing output
            docker buildx build \
              --platform linux/amd64 \
              --target test \
              --build-arg APP_VERSION=${IMAGE_TAG} \
              --build-arg RUN_TESTS=true \
              --network host \
              -t hedlaron/microadventures-backend:${IMAGE_TAG}-test \
              --load \
              . 2>&1 | tee "$TEST_OUTPUT_FILE"

            # Extract test results from Docker build output
            echo "## ðŸ§ª Backend Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Look for test summary in the output
            if grep -q "collected.*items" "$TEST_OUTPUT_FILE"; then
              echo "### Test Summary" >> $GITHUB_STEP_SUMMARY
              grep -A 10 -B 2 "collected.*items" "$TEST_OUTPUT_FILE" | sed 's/^/    /' >> $GITHUB_STEP_SUMMARY
            fi

            # Look for coverage information
            if grep -q "TOTAL.*%" "$TEST_OUTPUT_FILE"; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -A 20 "Name.*Stmts.*Miss.*Cover" "$TEST_OUTPUT_FILE" | head -25 >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi

            echo "Backend tests completed in Docker build"

          elif [[ "${{ matrix.path }}" == "components/frontend" ]]; then
            echo "Building and testing frontend in container..."
            # Build test stage and run tests, capturing output
            docker buildx build \
              --platform linux/amd64 \
              --target test \
              --build-arg APP_VERSION=${IMAGE_TAG} \
              --build-arg RUN_TESTS=true \
              -t hedlaron/microadventures-frontend:${IMAGE_TAG}-test \
              --load \
              . 2>&1 | tee "$TEST_OUTPUT_FILE"

            # Extract test results from Docker build output
            echo "## ðŸŽ¨ Frontend Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Look for lint results
            if grep -q "âœ–.*problems" "$TEST_OUTPUT_FILE"; then
              echo "### Linting Results" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -A 10 -B 5 "âœ–.*problems" "$TEST_OUTPUT_FILE" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            elif grep -q "eslint" "$TEST_OUTPUT_FILE" && ! grep -q "âœ–" "$TEST_OUTPUT_FILE"; then
              echo "### âœ… Linting Results" >> $GITHUB_STEP_SUMMARY
              echo "All linting checks passed!" >> $GITHUB_STEP_SUMMARY
            fi

            # Look for test results
            if grep -q "Test Files.*passed" "$TEST_OUTPUT_FILE"; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Test Results" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -A 5 -B 2 "Test Files.*passed" "$TEST_OUTPUT_FILE" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi

            echo "Frontend tests completed in Docker build"
          fi

          # Clean up temp file
          rm -f "$TEST_OUTPUT_FILE"

      - name: Post test summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Component**: ${{ matrix.path }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: ${{ needs.generate-image-tag.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push production image
        env:
          IMAGE_TAG: ${{ needs.generate-image-tag.outputs.image_tag }}
        working-directory: ${{ matrix.path }}
        run: |
          echo "Building production image for ${{ matrix.path }} with tag ${IMAGE_TAG}"
          task build-container-image-multi-arch IMAGE_TAG=${IMAGE_TAG}

  update-tags:
    runs-on: ubuntu-latest
    needs: [generate-image-tag, build-tag-push]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: 3.x

      - name: Update Image Tags
        working-directory: cicd/github-actions
        env:
          IMAGE_TAG: ${{ needs.generate-image-tag.outputs.image_tag }}
        run: |
          # Update staging tags for push to master or release tag
          task update-staging-image-tags NEW_TAG=${IMAGE_TAG}

          # Update production tags for push to master or release tag
          task update-production-image-tags NEW_TAG=${IMAGE_TAG}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          base: master
          token: ${{ secrets.MICROADVENTURES_GHA_PAT }}
          title: "Update image tags to (${{ needs.generate-image-tag.outputs.image_tag }})"
