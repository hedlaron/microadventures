name: 'Test and Report'
description: 'Run tests in Docker and summarize results for GitHub Actions summary.'
inputs:
  component:
    description: 'Component to test (backend or frontend)'
    required: true
  image_tag:
    description: 'Docker image tag to use'
    required: true
runs:
  using: 'composite'
  steps:
    - name: Trufflehog secret scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: .
        extra_args: --no-update --fail --exclude-path .trufflehogignore
    - name: Trivy image security scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ inputs.component == 'backend' && format('hedlaron/microadventures-backend:{0}-test', inputs.image_tag) || format('hedlaron/microadventures-frontend:{0}-test', inputs.image_tag) }}
        format: 'table'
        exit-code: '1'
        severity: 'HIGH,CRITICAL'
        ignore-unfixed: true
    - name: Run tests and summarize
      shell: bash
      run: |
        COMPONENT="${{ inputs.component }}"
        IMAGE_TAG="${{ inputs.image_tag }}"
        if [[ "$COMPONENT" == "backend" ]]; then
          echo "‚úÖ Backend Docker build completed successfully" >> $GITHUB_WORKSPACE/test-summary.txt
          echo "## üß™ Backend Test Results" >> $GITHUB_WORKSPACE/test-summary.txt
          echo '' >> $GITHUB_WORKSPACE/test-summary.txt
          BACKEND_TEST_OUTPUT=$(docker run --rm hedlaron/microadventures-backend:${IMAGE_TAG}-test uv run pytest --cov=. --cov-report=term-missing --maxfail=1 --tb=short 2>&1)
          # Extract test summary line (e.g. '=== 12 passed, 1 warning in 0.12s ===')
          BACKEND_TEST_SUMMARY=$(echo "$BACKEND_TEST_OUTPUT" | grep -E '^=+ .+ in .+s =+$' | tail -1)
          # Extract coverage percent (e.g. 'TOTAL ... 95%')
          BACKEND_COV_LINE=$(echo "$BACKEND_TEST_OUTPUT" | grep -E '^TOTAL' | tail -1)
          BACKEND_COV_PCT=$(echo "$BACKEND_COV_LINE" | awk '{print $NF}')
          echo "**Backend Test Summary:** $BACKEND_TEST_SUMMARY" >> $GITHUB_WORKSPACE/test-summary.txt
          if [ -n "$BACKEND_COV_PCT" ]; then
            echo "**Backend Coverage:** $BACKEND_COV_PCT" >> $GITHUB_WORKSPACE/test-summary.txt
          fi
          elif echo "$BACKEND_TEST_OUTPUT" | grep -q 'ValidationError'; then
            echo '<details open><summary><span style="color:red;font-weight:bold;">‚ùå Backend Environment Error (click to expand)</span></summary>' >> $GITHUB_WORKSPACE/test-summary.txt
            echo '' >> $GITHUB_WORKSPACE/test-summary.txt
            echo '```' >> $GITHUB_WORKSPACE/test-summary.txt
            echo "$BACKEND_TEST_OUTPUT" >> $GITHUB_WORKSPACE/test-summary.txt
            echo '```' >> $GITHUB_WORKSPACE/test-summary.txt
            echo '<br><b>‚ùóÔ∏è Environment variables missing for backend tests. See error details above.</b>' >> $GITHUB_WORKSPACE/test-summary.txt
            echo '</details>' >> $GITHUB_WORKSPACE/test-summary.txt
          else
            echo '<details open><summary><span style="color:green;font-weight:bold;">‚úÖ Backend Tests Passed (click to expand)</span></summary>' >> $GITHUB_WORKSPACE/test-summary.txt
            echo '' >> $GITHUB_WORKSPACE/test-summary.txt
            echo '```' >> $GITHUB_WORKSPACE/test-summary.txt
            echo "$BACKEND_TEST_OUTPUT" >> $GITHUB_WORKSPACE/test-summary.txt
            echo '```' >> $GITHUB_WORKSPACE/test-summary.txt
            echo '</details>' >> $GITHUB_WORKSPACE/test-summary.txt
          fi
          echo '' >> $GITHUB_WORKSPACE/test-summary.txt
          echo "### Backend Coverage Summary" >> $GITHUB_WORKSPACE/test-summary.txt
          BACKEND_COV=$(docker run --rm hedlaron/microadventures-backend:${IMAGE_TAG}-test cat /app/htmlcov/index.html 2>/dev/null | grep -A 10 '<h2>Coverage summary' | head -n 12)
          if [ -z "$BACKEND_COV" ]; then
            echo '<span style="color:orange;">‚ö†Ô∏è No backend coverage report found.</span>' >> $GITHUB_WORKSPACE/test-summary.txt
          else
            echo '```html' >> $GITHUB_WORKSPACE/test-summary.txt
            echo "$BACKEND_COV" >> $GITHUB_WORKSPACE/test-summary.txt
            echo '```' >> $GITHUB_WORKSPACE/test-summary.txt
          fi
        elif [[ "$COMPONENT" == "frontend" ]]; then
          echo "‚úÖ Frontend Docker build completed successfully" >> $GITHUB_WORKSPACE/test-summary.txt
          echo "## üé® Frontend Test Results" >> $GITHUB_WORKSPACE/test-summary.txt
          echo '' >> $GITHUB_WORKSPACE/test-summary.txt
          FRONTEND_TEST_OUTPUT=$(docker run --rm hedlaron/microadventures-frontend:${IMAGE_TAG}-test npm run test:coverage 2>&1)
          # Extract test summary line (e.g. 'Test Files  3 passed | 0 failed')
          FRONTEND_TEST_SUMMARY=$(echo "$FRONTEND_TEST_OUTPUT" | grep -E 'Test Files|Tests:|Suites:|Snapshots:|Time:')
          # Extract coverage percent (e.g. 'Statements   : 95.00%')
          FRONTEND_COV_PCT=$(echo "$FRONTEND_TEST_OUTPUT" | grep -E 'Statements\s*:' | awk -F: '{print $2}' | awk '{print $1}')
          echo "**Frontend Test Summary:**" >> $GITHUB_WORKSPACE/test-summary.txt
          echo '```' >> $GITHUB_WORKSPACE/test-summary.txt
          echo "$FRONTEND_TEST_SUMMARY" >> $GITHUB_WORKSPACE/test-summary.txt
          echo '```' >> $GITHUB_WORKSPACE/test-summary.txt
          if [ -n "$FRONTEND_COV_PCT" ]; then
            echo "**Frontend Coverage:** $FRONTEND_COV_PCT" >> $GITHUB_WORKSPACE/test-summary.txt
          fi
          if echo "$FRONTEND_TEST_OUTPUT" | grep -q 'FAIL'; then
            echo '<details><summary><span style="color:red;font-weight:bold;">‚ùå Frontend Tests Failed (click to expand)</span></summary>' >> $GITHUB_WORKSPACE/test-summary.txt
            echo '' >> $GITHUB_WORKSPACE/test-summary.txt
            echo '```' >> $GITHUB_WORKSPACE/test-summary.txt
            echo "$FRONTEND_TEST_OUTPUT" >> $GITHUB_WORKSPACE/test-summary.txt
            echo '```' >> $GITHUB_WORKSPACE/test-summary.txt
            echo '</details>' >> $GITHUB_WORKSPACE/test-summary.txt
          elif echo "$FRONTEND_TEST_OUTPUT" | grep -q 'No tests found'; then
            echo '<span style="color:orange;">‚ö†Ô∏è No frontend tests found or executed.</span>' >> $GITHUB_WORKSPACE/test-summary.txt
          else
            echo '<details open><summary><span style="color:green;font-weight:bold;">‚úÖ Frontend Tests Passed (click to expand)</span></summary>' >> $GITHUB_WORKSPACE/test-summary.txt
            echo '' >> $GITHUB_WORKSPACE/test-summary.txt
            echo '```' >> $GITHUB_WORKSPACE/test-summary.txt
            echo "$FRONTEND_TEST_OUTPUT" >> $GITHUB_WORKSPACE/test-summary.txt
            echo '```' >> $GITHUB_WORKSPACE/test-summary.txt
            echo '</details>' >> $GITHUB_WORKSPACE/test-summary.txt
          fi
          echo '' >> $GITHUB_WORKSPACE/test-summary.txt
          echo "### Frontend Coverage Summary" >> $GITHUB_WORKSPACE/test-summary.txt
          FRONTEND_COV=$(docker run --rm hedlaron/microadventures-frontend:${IMAGE_TAG}-test cat /usr/src/app/coverage/coverage-summary.json 2>/dev/null)
          if [ -z "$FRONTEND_COV" ]; then
            echo '<span style="color:orange;">‚ö†Ô∏è No frontend coverage report found.</span>' >> $GITHUB_WORKSPACE/test-summary.txt
          else
            echo '```json' >> $GITHUB_WORKSPACE/test-summary.txt
            echo "$FRONTEND_COV" >> $GITHUB_WORKSPACE/test-summary.txt
            echo '```' >> $GITHUB_WORKSPACE/test-summary.txt
          fi
        fi
