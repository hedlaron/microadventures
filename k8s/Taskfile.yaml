version: "3"

env:
  # Set default gum style options
  BORDER: double
  BORDER_FOREGROUND: "212"
  PADDING: "1 1"
  MARGIN: "1 1"

includes:
  common:
    taskfile: ./common/Taskfile.yaml
    dir: ./common
  postgresql:
    taskfile: ./postgresql/Taskfile.yaml
    dir: ./postgresql
  backend:
    taskfile: ./backend/Taskfile.yaml
    dir: ./backend

tasks:
  backend:apply:
    desc: "Apply kubernetes resource manifests for backend application"
    cmds:
      - "kubectl apply -f ./backend"

  frontend:apply:
    desc: "Apply kubernetes resource manifests for frontend application"
    cmds:
      - "kubectl apply -f ./frontend"

  backend:create-image-pull-secret:
    desc: "Create image pull secret to pull from private registry"
    cmds:
      - |
        if [ -z "$DOCKER_USERNAME" ] || [ -z "$DOCKER_EMAIL" ] || [ -z "$DOCKER_PASSWORD" ]; then
          echo "Environment variables DOCKER_USERNAME, DOCKER_EMAIL, and DOCKER_PASSWORD are required."
          echo "Usage: DOCKER_USERNAME=your_username DOCKER_EMAIL=your_email DOCKER_PASSWORD=your_password task backend:create-image-pull-secret"
          exit 1
        fi
      - |
        kubectl create secret -n microadventures docker-registry dockerconfigjson \
          --docker-email=${DOCKER_EMAIL} \
          --docker-username=${DOCKER_USERNAME} \
          --docker-password=${DOCKER_PASSWORD} \
          --docker-server=https://index.docker.io/v1/

  apply-all:
    desc: "Apply kubernetes resource manifests for all applications"
    cmds:
      - "kubectl apply -f ./backend"
      - "kubectl apply -f ./frontend"
      - "kubectl apply -f ./postgresql"